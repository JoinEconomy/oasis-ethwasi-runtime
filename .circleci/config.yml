version: 2
jobs:
  build:
    docker:
      - image: ekiden/testing
    steps:
      # Set up
      - run: echo 'PS1='"'"'\$ '"'"'; . /root/.bashrc' >> $BASH_ENV
      - run: echo 'export SGX_MODE=SIM' >> $BASH_ENV
      - run: echo 'export INTEL_SGX_SDK=/opt/sgxsdk' >> $BASH_ENV
      - checkout

      # Install Ekiden binaries.
      # TODO: Use 0.1.0-alpha.2 when released.
      - run: cargo install --git https://github.com/oasislabs/ekiden --tag 0.1.0-alpha.2 ekiden-tools
      - run: cargo install --git https://github.com/oasislabs/ekiden --tag 0.1.0-alpha.2 ekiden-compute
      - run: cargo install --git https://github.com/oasislabs/ekiden --tag 0.1.0-alpha.2 ekiden-consensus
      # Build key manager contract.
      - run: |
          cargo ekiden build-contract \
              --git https://github.com/oasislabs/ekiden \
              --tag 0.1.0-alpha.2 \
              --output target/contract \
              ekiden-key-manager
      # Build hello world contract.
      - run: cargo ekiden build-contract --output-identity
      # Run hello world contract tests.
      - run: cargo test
      # Build hello world client.
      - run:
          command: cargo build
          working_directory: examples/client
      # Check style. This needs to be after everything is built.
      - run: cargo fmt -- --write-mode=diff

      # Contract end-to-end tests.

      # Start the consensus node.
      - run:
          command: ekiden-consensus
          background: true
      # Start tendermint node.
      - run: tendermint init
      - run:
          command: tendermint node --consensus.create_empty_blocks=false --rpc.laddr tcp://0.0.0.0:46666 --rpc.grpc_laddr tcp://0.0.0.0:46657
          background: true
      # Start key manager compute node.
      - run:
          command: ekiden-compute target/contract/ekiden-key-manager.so -p 9003 --disable-key-manager --identity-file identity-km.pb
          background: true
      # Start hello world compute node.
      - run:
          command: ekiden-compute target/contract/helloworld.so --identity-file identity-helloworld.pb
          background: true
      # Start hello world client.
      - run:
          command: ./target/debug/helloworld-client --mr-enclave $(cat ../../target/contract/helloworld.mrenclave)
          working_directory: examples/client

workflows:
  version: 2
  build:
    jobs:
      - build
experimental:
  notify:
    branches:
      only:
        - master
